{% extends "base.html" %}

{% block title %}{{ title }} - Zendesk Giga Tools{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('jobs.index') }}">Jobs</a></li>
                    <li class="breadcrumb-item active">Job #{{ job.id }}</li>
                </ol>
            </nav>
            <h2><i class="bi bi-clock-history me-2"></i>Job #{{ job.id }}</h2>
            <p class="text-muted">Tool: <span class="badge bg-secondary">{{ job.tool_slug }}</span></p>
        </div>
    </div>

    <!-- Status Card -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Job Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Status:</strong>
                                <span id="job-status">
                                    {% if job.status == 'completed' %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>
                                    {% elif job.status == 'running' %}
                                    <span class="badge bg-primary"><i class="bi bi-arrow-repeat me-1"></i>Running</span>
                                    {% elif job.status == 'pending' %}
                                    <span class="badge bg-warning"><i class="bi bi-clock me-1"></i>Pending</span>
                                    {% elif job.status == 'failed' %}
                                    <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Failed</span>
                                    {% elif job.status == 'cancelled' %}
                                    <span class="badge bg-secondary"><i class="bi bi-dash-circle me-1"></i>Cancelled</span>
                                    {% endif %}
                                </span>
                            </p>
                            <p><strong>Created:</strong> {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            {% if job.started_at %}
                            <p><strong>Started:</strong> {{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            {% endif %}
                            {% if job.completed_at %}
                            <p><strong>Completed:</strong> {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            {% endif %}
                            <p><strong>Duration:</strong> <span id="job-duration">{{ job.get_elapsed_time() }}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Items:</strong> <span id="job-total">{{ job.total_items }}</span></p>
                            <p><strong>Processed:</strong> <span id="job-processed">{{ job.processed_items }}</span> / <span id="job-total-2">{{ job.total_items }}</span></p>
                            <p><strong>Progress:</strong></p>
                            <div class="progress" style="height: 30px;">
                                <div id="job-progress-bar"
                                     class="progress-bar {% if job.status == 'failed' %}bg-danger{% elif job.status == 'completed' %}bg-success{% endif %}"
                                     role="progressbar"
                                     style="width: {{ job.progress }}%"
                                     aria-valuenow="{{ job.progress }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    <span id="job-progress-text">{{ job.progress }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Message -->
                    {% if job.error_message %}
                    <div class="alert alert-danger mt-3" id="error-message">
                        <strong><i class="bi bi-exclamation-triangle me-2"></i>Error:</strong> {{ job.error_message }}
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="mt-3">
                        {% if job.status in ['pending', 'running'] %}
                        <form method="post" action="{{ url_for('jobs.cancel_job', job_id=job.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this job?')">
                                <i class="bi bi-stop-circle me-1"></i>Cancel Job
                            </button>
                        </form>
                        {% elif job.status in ['completed', 'failed', 'cancelled'] %}
                        <form method="post" action="{{ url_for('jobs.delete_job', job_id=job.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this job record?')">
                                <i class="bi bi-trash me-1"></i>Delete Job
                            </button>
                        </form>
                        {% endif %}
                        <a href="{{ url_for('jobs.index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Back to Jobs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Card -->
    {% if job.status == 'completed' and job.get_result() %}
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Results</h5>
                </div>
                <div class="card-body">
                    {% set result = job.get_result() %}

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3>{{ result.successful|length if result.successful else 0 }}</h3>
                                    <p class="mb-0">Successful</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h3>{{ result.failed|length if result.failed else 0 }}</h3>
                                    <p class="mb-0">Failed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3>{{ job.total_items }}</h3>
                                    <p class="mb-0">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if result.errors %}
                    <h6 class="mt-4">Errors:</h6>
                    <div class="alert alert-warning">
                        <ul class="mb-0">
                            {% for error in result.errors[:10] %}
                            <li>{{ error }}</li>
                            {% endfor %}
                            {% if result.errors|length > 10 %}
                            <li><em>... and {{ result.errors|length - 10 }} more errors</em></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript for real-time updates -->
{% if job.status in ['pending', 'running'] %}
<script>
    // Poll for job status updates every 2 seconds
    const jobId = {{ job.id }};
    const statusUrl = "{{ url_for('jobs.job_status_api', job_id=job.id) }}";

    function updateJobStatus() {
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                // Update status badge
                let statusHtml = '';
                switch(data.status) {
                    case 'completed':
                        statusHtml = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>';
                        break;
                    case 'running':
                        statusHtml = '<span class="badge bg-primary"><i class="bi bi-arrow-repeat me-1"></i>Running</span>';
                        break;
                    case 'pending':
                        statusHtml = '<span class="badge bg-warning"><i class="bi bi-clock me-1"></i>Pending</span>';
                        break;
                    case 'failed':
                        statusHtml = '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Failed</span>';
                        break;
                    case 'cancelled':
                        statusHtml = '<span class="badge bg-secondary"><i class="bi bi-dash-circle me-1"></i>Cancelled</span>';
                        break;
                }
                document.getElementById('job-status').innerHTML = statusHtml;

                // Update progress
                const progressBar = document.getElementById('job-progress-bar');
                const progressText = document.getElementById('job-progress-text');
                progressBar.style.width = data.progress + '%';
                progressBar.setAttribute('aria-valuenow', data.progress);
                progressText.textContent = data.progress + '%';

                // Update progress bar color based on status
                progressBar.className = 'progress-bar';
                if (data.status === 'failed') {
                    progressBar.classList.add('bg-danger');
                } else if (data.status === 'completed') {
                    progressBar.classList.add('bg-success');
                }

                // Update processed items
                document.getElementById('job-processed').textContent = data.processed_items;
                document.getElementById('job-total').textContent = data.total_items;
                document.getElementById('job-total-2').textContent = data.total_items;

                // Update duration
                document.getElementById('job-duration').textContent = data.elapsed_time;

                // If job is complete, reload the page to show results
                if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error fetching job status:', error);
            });
    }

    // Poll every 2 seconds
    const pollInterval = setInterval(updateJobStatus, 2000);

    // Stop polling when page is unloaded
    window.addEventListener('beforeunload', () => {
        clearInterval(pollInterval);
    });
</script>
{% endif %}
{% endblock %}
